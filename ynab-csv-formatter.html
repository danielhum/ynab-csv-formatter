<html>
  <head>
    <title>YNAB CSV Formatter</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="papaparse.min.js"></script>
    <script>
      // only for UOB xls file
      function parseFile(input) {
        if (!(input.files && input.files[0])) {
          console.log("File not found!");
          return;
        }
        file = input.files[0];
        filename = file.name;
        if (/\.xlsx?$/.test(filename)) {
          parseXLSX(file);
        } else {
          parseOcbc(file);
          //parseCSV(file, "amex_cc");
        }
      }

      function parseXLSX(file) {
        let reader = new FileReader();
        reader.onload = function(evt) {
          let data = new Uint8Array(evt.target.result);
          let workbook = XLSX.read(data, { type: 'array' });
          let sheet = workbook.Sheets[workbook.SheetNames[0]];
          let accountMetas = {
            "uob_deposit" : {
              "headers": [
                "Transaction Date",
                "Transaction Description",
                "Withdrawal",
                "Deposit",
                "Available Balance"
              ],
              "dateHeader": "Transaction Date",
              "payeeHeader": "Transaction Description",
              "debitHeader": "Withdrawal",
              "creditHeader": "Deposit"
            },
            "uob_cc" : {
              "headers": [
                "Transaction Date",
                "Posting Date",
                "Description",
                "Foreign Currency Type",
                "Transaction Amount(Foreign)",
                "Local Currency Type",
                "Transaction Amount(Local)",
              ],
              "dateHeader": "Transaction Date",
              "payeeHeader": "Description",
              "debitHeader": "Transaction Amount(Local)",
              "creditHeader": null
            }
          }
          accountTypes = Object.keys(accountMetas);
          processed = []
          var accountType = null;
          var meta = null;
          for (i = 0; processed.length == 0; i++) {
            accountType = accountTypes[i];
            meta = accountMetas[accountType]
            h = meta["headers"]
            json = XLSX.utils.sheet_to_json(sheet, { header: h });
            processed = json.filter(function(row) {
              let date = Date.parse(row[meta["dateHeader"]]);
              let withdrawal = typeof row[meta["debitHeader"]] == "number";
              let deposit = typeof row[meta["creditHeader"]] == "number";

              return ((date && date != "NaN") && (withdrawal || deposit));
            });
            console.log(json);
            console.log(processed);
          }

          if (processed.length == 0) {
            alert("Couldn't parse file!");
            return;
          } else {
            console.log("type: " + accountType);
          }

          outData = [];
          processed.forEach(element => {
            let date = new Date(Date.parse(element[meta.dateHeader]));
            let formattedDate = date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear();
            let payee = element[meta.payeeHeader]
            if (payee.toLowerCase().includes("fee")) alert("Fee detected!");

            outData.push({
              "Date": formattedDate,
              "Payee": element[meta.payeeHeader],
              "Memo": "",
              "Outflow": element[meta.debitHeader],
              "Inflow": element[meta.creditHeader],
            })
          });
          console.log(outData);
          let outSheet = XLSX.utils.json_to_sheet(outData);
          let outWb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(outWb, outSheet, "Sheet0");
          XLSX.writeFile(outWb, file.name + ".ynab.csv", { type: "csv" })
        }
        reader.readAsArrayBuffer(file);
      }

      function handleParseCSVResults(results) {
        var data = results.data;
        var errors = results.errors.filter(error => {
          if(error.code == "TooFewFields" &&
              error.row == data.length-1) {
                data.pop();
                return false;
              } else {
                return true;
              }
        });
        //data.forEach(el => { el["Memo"] = "" });
        return { data: data, errors: errors };
      }

      function ocbcProcessPayeeAndMemo(originalPayee, desc) {
        const regex1 = /^to (?<payee>.+) via PayNow-\w+ OTHR - (?<memo>.+)/mg;
        const regex2 = /^OTHR( -)? (?<memo>.+) (to|from) (?<payee>.+) via PayNow/mg;
        const regex3 = /^OTHR( -)? (?<memo>.+) (to|from) (?<payee>.+)/mg;
        var payee = "";
        var memo = "";
        switch(originalPayee) {
          case "PAYMENT/TRANSFER":
          case "FAST PAYMENT":
          case "FUND TRANSFER":
            let match = regex1.exec(desc);
            if (match == null) {
              match = regex2.exec(desc);
            }
            if (match == null) {
              match = regex3.exec(desc);
            }
            if (match.groups.payee) payee = `"${match.groups.payee}"`;
            if (match.groups.memo) memo = `"${match.groups.memo}"`;
            break;
          case "GIRO":
          default:
            payee = `"${originalPayee} ${desc}"`
            memo = ""
        }
        return {
          payee: payee,
          memo: memo
        }
      }

      // handles OCBC non-standard content
      function parseOcbc(file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          let lines = event.target.result.split(/\r\n|\n/);
          var newLines = [];
          console.log(`cleaning ${lines.length} lines`);
          lines.forEach((line, i) => {
            if (line.startsWith(",,")) {
              var prevLine = newLines[newLines.length-1].split(",");
              const {payee, memo} = ocbcProcessPayeeAndMemo(prevLine[2], line.substring(2));
              prevLine[2] = payee
              prevLine[5] = memo
              newLines[newLines.length-1] = prevLine.join(",");
            } else if (i == 0) {
              newLines.push(line + ",Memo"); // add memo header
            } else if (line.length > 0) {
              match = line.match(/"[0-9,\.]+"/)
              if (match != null) {
                priceQuot = line.match(/"[0-9,\.]+"/)[0]
                line = line.replace(priceQuot, priceQuot.replace(",",""));
              }
              newLines.push(line + ","); // add memo field 
            }
          });
          let output = newLines.join("\n");
          parseCSV(output, "ocbc");
        }
        reader.readAsText(file);
        return;
      }

      function parseCSV(csvFile, bank = "amex_cc") {
        console.log("parseCSV");

        let accountMetas = {
          "ocbc" : {
            "dateHeader": "Transaction date",
            "payeeHeader": "Description",
            "debitHeader": "Withdrawals (SGD)",
            "creditHeader": "Deposits (SGD)",
            "memoHeader": "Memo"
          },
          "amex_cc" : {
            "dateHeader": "Date",
            "payeeHeader": "Payee",
            "debitHeader": "Outflow",
            "creditHeader": "",
            "memoHeader": "Memo"
          }
        }
        meta = accountMetas[bank];
        Papa.parse(csvFile, {
          delimiter: ",",
          comments: "#",
          dynamicTyping: true,
          header: true,
          transformHeader: function(header, _idx) {
            switch(header) {
              case meta["dateHeader"]:
                return "Date";
              case meta["payeeHeader"]:
                return "Payee";
              case meta["debitHeader"]:
                return "Outflow";
              case meta["creditHeader"]:
                return "Inflow";
              case meta["memoHeader"]:
                return "Memo";
              default:
                return "unknown_header";

            }
          },
          complete: function(results) {
            console.log("parse CSV results:");
            console.log(results);
            processed = handleParseCSVResults(results);
            if (processed.errors.length > 0) {
              alert("parsing error!");
              //return;
            }
            processData(processed.data, meta);
          }
        });
      }

      function downloadCSV(csv) {
        var csvData = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
        var csvURL =  null;
        if (navigator.msSaveBlob)
        {
          csvURL = navigator.msSaveBlob(csvData, 'download.csv');
        }
        else
        {
          csvURL = window.URL.createObjectURL(csvData);
        }

        var tempLink = document.createElement('a');
        tempLink.href = csvURL;
        tempLink.setAttribute('download', 'download.csv');
        tempLink.click();
      }

      function processData(data, meta) {
        console.log(data);
        csv = Papa.unparse(data);
        downloadCSV(csv);
      }
    </script>
  </head>
  <body>
    <input type="file" id="fileSelector" onchange="parseFile(this)" />
  </body>
</html>
